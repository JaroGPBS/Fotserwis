<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fotserwis</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#22c55e}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:16px 16px 100px}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.9));backdrop-filter:saturate(180%) blur(8px);z-index:10;border-bottom:1px solid #1f2937}
    header .bar{display:flex;gap:12px;align-items:center;padding:12px 16px}
    input,button,select{font:inherit}
    .input{background:#0b1220;border:1px solid #223;outline:none;border-radius:12px;padding:12px 14px;color:var(--text)}
    .btn{background:var(--accent);color:#062a12;border:none;border-radius:12px;padding:12px 16px;font-weight:600}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .btn:disabled{opacity:.5}
    .seg{display:inline-flex;background:#0b1220;border:1px solid #223;border-radius:12px;overflow:hidden}
    .seg button{background:transparent;color:var(--text);padding:10px 14px;border:none}
    .seg button.active{background:#10b98122}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin-top:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid #1f2937;background:#0b1220}
    .thumb img{display:block;width:100%;height:140px;object-fit:cover}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px dashed #374151;color:#cbd5e1}
    footer{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(0deg,rgba(15,23,42,.98),rgba(15,23,42,.9));border-top:1px solid #1f2937;padding:10px 16px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>Maszyny – PRZED/PO</strong>
      <span class="muted" id="status">Wybierz katalog zapisu…</span>
      <div class="grow"></div>
      <button class="btn secondary" id="pickRoot">📁 Wybierz katalog</button>
      <button class="btn secondary" id="installBtn" hidden>⬇️ Zainstaluj</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row" style="gap:10px">
        <input id="machine" class="input grow" placeholder="Numer maszyny (np. 1234-AB)" autocomplete="off"/>
        <div class="seg" role="tablist" aria-label="Tryb">
          <button type="button" id="modeBefore" class="active">PRZED</button>
          <button type="button" id="modeAfter">PO</button>
        </div>
        <input id="file" type="file" accept="image/*" capture="environment" hidden multiple>
        <button class="btn" id="shoot">📸 Zrób/Zaznacz zdjęcia</button>
      </div>
      <p class="muted" style="margin-top:8px">Zdjęcia trafią do: <code id="pathPreview">(brak)</code></p>
      <div class="row" style="margin-top:8px">
        <span class="pill" id="permInfo">Uprawnienia: brak</span>
        <span class="pill" id="apiInfo">Zapisywanie: auto-foldery <span id="apiBadge">(sprawdzanie…)</span></span>
      </div>
    </div>

    <div class="card">
      <h3>Ostatnie zdjęcia</h3>
      <div class="grid" id="gallery"></div>
    </div>

    <div class="card">
      <h3>Wskazówki</h3>
      <ul>
        <li>Najpierw kliknij <strong>„Wybierz katalog”</strong> i wskaż folder główny, w którym powstaną katalogi <code>Maszyny/&lt;NUMER&gt;/PRZED|PO</code>.</li>
        <li>Wpisz numer maszyny, wybierz <strong>PRZED</strong> lub <strong>PO</strong>, a potem zrób zdjęcia.</li>
        <li>Jeśli Twoja przeglądarka nie wspiera automatycznego zapisu do folderów, każde zdjęcie pobierze się z poprawną nazwą — zapisz je w odpowiednich katalogach.</li>
      </ul>
    </div>
  </div>

  <footer>
    <div class="row">
      <small class="muted">PWA offline: zainstaluj, aby działać bez sieci. Uprawnienia do katalogu zapamiętywane lokalnie.</small>
      <div class="grow"></div>
      <small class="muted">© Twoja firma</small>
    </div>
  </footer>

  <script>
  // ========= PWA install prompt =========
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.hidden = false; });
  installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.hidden = true; deferredPrompt = null; });
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

  // ========= IndexedDB helpers to store directory handle =========
  const DB_NAME = 'maszyny-store';
  const STORE = 'handles';
  function idb(){ return new Promise((res,rej)=>{ const r = indexedDB.open(DB_NAME,1); r.onupgradeneeded = ()=>{ r.result.createObjectStore(STORE); }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
  async function idbSet(key,val){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(val,key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
  async function idbGet(key){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(key); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }

  // ========= UI refs =========
  const statusEl = document.getElementById('status');
  const pickBtn = document.getElementById('pickRoot');
  const machineEl = document.getElementById('machine');
  const modeBefore = document.getElementById('modeBefore');
  const modeAfter = document.getElementById('modeAfter');
  const shootBtn = document.getElementById('shoot');
  const fileInput = document.getElementById('file');
  const gallery = document.getElementById('gallery');
  const pathPreview = document.getElementById('pathPreview');
  const permInfo = document.getElementById('permInfo');
  const apiBadge = document.getElementById('apiBadge');

  let rootHandle = null;
  let mode = 'PRZED';

  // ========= Capability detection =========
  const hasFS = !!window.showDirectoryPicker;
  apiBadge.textContent = hasFS ? '(automatyczny zapis dostępny)' : '(fallback: pobieranie plików)';

  function fmt(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }
  function sanitize(s){ return (s||'').replace(/[^0-9A-Za-z._-]+/g,'-').slice(0,64); }

  function updatePathPreview(){
    const m = sanitize(machineEl.value || 'BRAK');
    pathPreview.textContent = `Maszyny/${m}/${mode}`;
  }

  modeBefore.addEventListener('click',()=>{ mode='PRZED'; modeBefore.classList.add('active'); modeAfter.classList.remove('active'); updatePathPreview();});
  modeAfter.addEventListener('click',()=>{ mode='PO'; modeAfter.classList.add('active'); modeBefore.classList.remove('active'); updatePathPreview();});
  machineEl.addEventListener('input',updatePathPreview);
  updatePathPreview();

  async function ensurePerms(){
    if(!rootHandle) return false;
    if(await rootHandle.queryPermission({mode:'readwrite'})==='granted') return true;
    const res = await rootHandle.requestPermission({mode:'readwrite'});
    return res==='granted';
  }

  async function pickRoot(){
    if(!hasFS){ alert('Twoja przeglądarka nie wspiera wyboru katalogu. Będzie użyty tryb pobierania plików.'); return; }
    rootHandle = await window.showDirectoryPicker({id:'maszyny-root'});
    await idbSet('root', rootHandle);
    statusEl.textContent = 'Wybrano katalog';
    permInfo.textContent = 'Uprawnienia: oczekujące';
    if(await ensurePerms()) permInfo.textContent = 'Uprawnienia: nadane';
  }

  pickBtn.addEventListener('click',pickRoot);

  (async()=>{ // przywróć handle z IndexedDB
    try{ const h = await idbGet('root'); if(h){ rootHandle = h; if(await ensurePerms()){ statusEl.textContent='Katalog zapamiętany'; permInfo.textContent='Uprawnienia: nadane'; } else { statusEl.textContent='Wybierz katalog zapisu…'; }} }catch(e){}
  })();

  function addThumb(file){
    const url = URL.createObjectURL(file);
    const d = document.createElement('div'); d.className='thumb';
    const img = document.createElement('img'); img.src=url; d.appendChild(img);
    gallery.prepend(d);
    setTimeout(()=>URL.revokeObjectURL(url), 60_000);
  }

  async function saveToFS(file){
    if(!rootHandle) throw new Error('Brak katalogu głównego');
    if(!(await ensurePerms())) throw new Error('Brak uprawnień do zapisu');
    const machine = sanitize(machineEl.value||'BRAK');
    // twórz strukturę Maszyny/<NUMER>/<PRZED|PO>
    const dirMaszyny = await rootHandle.getDirectoryHandle('Maszyny', {create:true});
    const dirMachine = await dirMaszyny.getDirectoryHandle(machine, {create:true});
    const dirMode = await dirMachine.getDirectoryHandle(mode, {create:true});

    // nazwa: NUMER_MODE_YYYYMMDD_HHMMSS_n.jpg
    const ts = fmt(Date.now());
    const base = `${machine}_${mode}_${ts}`;
    let idx=1, targetName=`${base}.jpg`;
    while(true){
      try{ await dirMode.getFileHandle(targetName); idx++; targetName=`${base}_${idx}.jpg`; }
      catch{ break; }
    }
    const handle = await dirMode.getFileHandle(targetName, {create:true});
    const ws = await handle.createWritable();
    await ws.write(file);
    await ws.close();
    return targetName;
  }

  async function saveFallback(file){
    const machine = sanitize(machineEl.value||'BRAK');
    const ts = fmt(Date.now());
    const name = `${machine}_${mode}_${ts}.jpg`;
    const a=document.createElement('a'); a.download=name; a.href=URL.createObjectURL(file); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 60_000);
    return name;
  }

  document.getElementById('shoot').addEventListener('click',()=> fileInput.click());

  fileInput.addEventListener('change', async ()=>{
    const files = Array.from(fileInput.files||[]);
    if(files.length===0) return;
    for(const f of files){
      addThumb(f);
      try{
        const name = hasFS && rootHandle ? await saveToFS(f) : await saveFallback(f);
        console.log('Zapisano', name);
      }catch(e){
        console.error(e);
        alert('Nie udało się zapisać: '+ e.message + '\nUżyję pobierania pliku.');
        await saveFallback(f);
      }
    }
    fileInput.value = '';
  });
  </script>
</body>
</html>
