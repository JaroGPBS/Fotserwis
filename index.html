<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FotSerwis</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#22c55e;--orange:#f59e0b}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 120px}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.9));backdrop-filter:saturate(180%) blur(8px);z-index:10;border-bottom:1px solid #1f2937}
    header .bar{display:flex;flex-direction:column;gap:6px;padding:12px 16px}
    .title{font-weight:800;font-size:20px}
    .subbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{font:inherit}
    .input{background:#0b1220;border:1px solid #223;outline:none;border-radius:12px;padding:10px 12px;color:var(--text);text-transform:uppercase}
    .btn{background:var(--accent);color:#062a12;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin-top:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .muted{color:var(--muted)}
    code{background:#0b1220;padding:2px 6px;border-radius:6px}
    footer{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(0deg,rgba(15,23,42,.98),rgba(15,23,42,.9));border-top:1px solid #1f2937;padding:10px 16px}
    /* PRZED/PO segment */
    .seg{display:flex;justify-content:center;border:1px solid #223;border-radius:12px;overflow:hidden;margin:8px auto 0;width:100%;max-width:540px;background:#0b1220}
    .seg button{flex:1;min-width:0;background:transparent;color:var(--text);padding:14px 16px;border:none;cursor:pointer;text-transform:uppercase;letter-spacing:.3px}
    .seg button.active{background:rgba(245,158,11,0.25); color:#fff; box-shadow: inset 0 0 0 2px rgba(245,158,11,0.5)}
    /* Thumbs 2x2 */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid #1f2937;background:#0b1220}
    .thumb img{display:block;width:100%;height:180px;object-fit:cover}
    @media (max-width:560px){
      .thumb img{height:160px;}
    }
    /* Machine list */
    ul.clean{list-style:none;padding-left:0;margin:8px 0}
    ul.clean li{padding:10px 12px;border:1px solid #1f2937;border-radius:10px;margin-bottom:8px;background:#0b1220;display:flex;justify-content:space-between}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">FotSerwis</div>
      <div class="subbar">
        <span class="muted">Folder:</span>
        <button class="btn secondary" id="pickRoot">üìÅ Wybierz:</button>
        <span class="muted" id="rootLabel">brak</span>
        <div class="grow"></div>
        <button class="btn secondary" id="installBtn" hidden>‚¨áÔ∏è Zainstaluj</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <input id="machine" class="input grow" placeholder="NUMER MASZYNY (np. 1234-AB)" autocomplete="off"/>
      </div>
      <div class="seg" role="tablist" aria-label="Tryb">
        <button type="button" id="modeBefore" class="active">PRZED</button>
        <button type="button" id="modeAfter">PO</button>
      </div>
      <div class="row" style="margin-top:10px;gap:10px;justify-content:center">
        <input id="file" type="file" accept="image/*" capture="environment" hidden multiple>
        <button class="btn" id="shoot" disabled>üì∏ Zr√≥b/Zaznacz zdjƒôcia</button>
      </div>
      <p class="muted" style="margin-top:8px;text-align:center">≈öcie≈ºka: <code id="pathPreview">‚Äî</code></p>
    </div>

    <div class="card">
      <h3>Ostatnie 4 zdjƒôcia</h3>
      <div class="grid" id="thumbs"></div>
    </div>

    <div class="card">
      <h3>Dzisiejsze maszyny (<span id="today"></span>)</h3>
      <ul class="clean" id="machinesToday"></ul>
    </div>
  </div>

  <footer>
    <div class="row">
      <small class="muted">¬© Jaro</small>
      <div class="grow"></div>
      <small class="muted">FotSerwis ver. 1.0.</small>
    </div>
  </footer>

  <script>
    // PWA install
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.hidden = false; });
    installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.hidden = true; deferredPrompt = null; });
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js?v=5'); }

    // IndexedDB to store directory handle
    const DB_NAME = 'maszyny-store';
    const STORE = 'handles';
    function idb(){ return new Promise((res,rej)=>{ const r = indexedDB.open(DB_NAME,1); r.onupgradeneeded = ()=>{ r.result.createObjectStore(STORE); }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
    async function idbSet(key,val){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(val,key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    async function idbGet(key){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(key); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }

    // Refs
    const pickBtn = document.getElementById('pickRoot');
    const rootLabel = document.getElementById('rootLabel');
    const machineEl = document.getElementById('machine');
    const modeBefore = document.getElementById('modeBefore');
    const modeAfter = document.getElementById('modeAfter');
    const shootBtn = document.getElementById('shoot');
    const fileInput = document.getElementById('file');
    const pathPreview = document.getElementById('pathPreview');
    const machinesTodayEl = document.getElementById('machinesToday');
    const todayEl = document.getElementById('today');
    const thumbs = document.getElementById('thumbs');

    // State
    let rootHandle = null;
    let rootName = '‚Äî';
    let mode = 'PRZED';
    let lastThumbs = []; // urls

    // Helpers
    const hasFS = !!window.showDirectoryPicker;
    const p = (n)=> String(n).padStart(2,'0');
    function ddmm(){ const d=new Date(); return `${p(d.getDate())}-${p(d.getMonth()+1)}`; }
    function isoDate(){ return new Date().toISOString().slice(0,10); }
    function sanitize(s){ return (s||'').toUpperCase().replace(/[^0-9A-Z._-]+/g,'-').slice(0,64); }
    function fmt(ts){ const d=new Date(ts); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`; }
    function modeFolder(){ return mode === 'PRZED' ? 'PRZED' : 'PO'; }

    function updatePath(){
      const mach = sanitize(machineEl.value || '');
      const preview = `${rootName}/${ddmm()}/${mach||'‚Äî'}/${modeFolder()}`;
      pathPreview.textContent = rootHandle ? preview : '‚Äî (najpierw wybierz katalog)';
      shootBtn.disabled = !(rootHandle && mach.length>0);
    }

    function dayKey(){ return 'machines_'+isoDate(); }
    function loadMachinesToday(){ try { return JSON.parse(localStorage.getItem(dayKey())||'[]'); } catch { return []; } }
    function saveMachinesToday(list){ localStorage.setItem(dayKey(), JSON.stringify(Array.from(new Set(list)))); }
    function renderMachinesToday(){
      machinesTodayEl.innerHTML = '';
      loadMachinesToday().forEach((num,i)=>{
        const li = document.createElement('li');
        li.innerHTML = `<span>${num}</span><span class="muted">#${String(i+1).padStart(2,'0')}</span>`;
        machinesTodayEl.appendChild(li);
      });
    }
    function addMachineToday(num){
      const list = loadMachinesToday();
      if(num && !list.includes(num)) list.unshift(num);
      saveMachinesToday(list.slice(0,200));
      renderMachinesToday();
    }

    function pushThumb(file){
      const url = URL.createObjectURL(file);
      lastThumbs.unshift(url);
      lastThumbs = lastThumbs.slice(0,4);
      renderThumbs();
      setTimeout(()=>{
        if(!lastThumbs.includes(url)) URL.revokeObjectURL(url);
      }, 60_000);
    }
    function renderThumbs(){
      thumbs.innerHTML = '';
      lastThumbs.forEach(u=>{
        const d = document.createElement('div'); d.className='thumb';
        const img = document.createElement('img'); img.src = u;
        d.appendChild(img);
        thumbs.appendChild(d);
      });
    }

    async function ensurePerms(){
      if(!rootHandle) return false;
      if(await rootHandle.queryPermission?.({mode:'readwrite'})==='granted') return true;
      const res = await rootHandle.requestPermission?.({mode:'readwrite'});
      return res==='granted';
    }

    async function pickRoot(){
      if(!hasFS){ alert('Twoja przeglƒÖdarka nie wspiera wyboru katalogu. U≈ºyje pobierania plik√≥w.'); rootHandle=null; rootName='Pobrane'; updatePath(); return; }
      rootHandle = await window.showDirectoryPicker({id:'fotserwis-root'});
      const db=await idb(); const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(rootHandle,'root'); await new Promise(r=>{tx.oncomplete=r;});
      rootName = (rootHandle.name || 'Wybrany folder');
      await ensurePerms();
      rootLabel.textContent = rootName;
      updatePath();
    }

    pickBtn.addEventListener('click', pickRoot);

    (async()=>{
      todayEl.textContent = isoDate();
      try{ 
        const db=await idb(); 
        const tx=db.transaction(STORE,'readonly'); 
        const req=tx.objectStore(STORE).get('root'); 
        const h = await new Promise((res,rej)=>{ req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });
        if(h){ rootHandle=h; rootName=h.name || 'Wybrany folder'; await ensurePerms(); rootLabel.textContent = rootName; } 
      }catch(e){}
      updatePath();
      renderMachinesToday();
      renderThumbs();
    })();

    modeBefore.addEventListener('click',()=>{ mode='PRZED'; modeBefore.classList.add('active'); modeAfter.classList.remove('active'); updatePath(); });
    modeAfter.addEventListener('click',()=>{ mode='PO'; modeAfter.classList.add('active'); modeBefore.classList.remove('active'); updatePath(); });

machineEl.addEventListener('input', ()=>{
  let val = machineEl.value.toUpperCase().replace(/[^A-Z0-9/]/g, '');

  // automatycznie wstaw "/" po drugim znaku, ale tylko je≈õli nie ma ≈ºadnego
  if (val.length === 2 && !val.includes('/')) {
    val = val + '/';
  }

  // je≈õli "/" istnieje, ale u≈ºytkownik go usunƒÖ≈Ç, nie dodawaj ponownie
  // dopiero gdy wpisuje od nowa bez "/"
  if (val.length > 2 && !val.includes('/')) {
    val = val.slice(0,2) + '/' + val.slice(2);
  }

  // ogranicz do 10 znak√≥w (np. 12/34AB56)
  if (val.length > 10) val = val.slice(0,10);

  machineEl.value = val;
  updatePath();
});



    document.getElementById('shoot').addEventListener('click', ()=> fileInput.click());

    async function saveToFS(file){
      if(!rootHandle) throw new Error('Brak katalogu g≈Ç√≥wnego');
      if(!(await ensurePerms())) throw new Error('Brak uprawnie≈Ñ do zapisu');
      const mach = sanitize(machineEl.value||'');
      const dateDir = ddmm();
      const dateHandle = await rootHandle.getDirectoryHandle(dateDir, {create:true});
      const machineHandle = await dateHandle.getDirectoryHandle(mach, {create:true});
      const modeHandle = await machineHandle.getDirectoryHandle(modeFolder(), {create:true});
      const ts = fmt(Date.now());
      const base = `${mach}_${mode}_${ts}`;
      let idx=1, targetName=`${base}.jpg`;
      try{
        while(true){
          await modeHandle.getFileHandle(targetName);
          idx++; targetName = `${base}_${idx}.jpg`;
        }
      }catch{}
      const handle = await modeHandle.getFileHandle(targetName, {create:true});
      const ws = await handle.createWritable();
      await ws.write(file);
      await ws.close();
      return targetName;
    }

    async function saveFallback(file){
      const mach = sanitize(machineEl.value||'');
      const ts = fmt(Date.now());
      const name = `${mach}_${mode}_${ts}.jpg`;
      const a=document.createElement('a'); a.download=name; a.href=URL.createObjectURL(file); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 60_000);
      return name;
    }

    fileInput.addEventListener('change', async ()=>{
      const files = Array.from(fileInput.files||[]);
      if(files.length===0) return;
      const mach = sanitize(machineEl.value||'');
      if(!mach){ alert('Wpisz numer maszyny.'); return; }
      addMachineToday(mach);
      for(const f of files){
        try{
          const name = (hasFS && rootHandle) ? await saveToFS(f) : await saveFallback(f);
          pushThumb(f);
          console.log('Zapisano', name);
        }catch(e){
          console.error(e);
          alert('Nie uda≈Ço siƒô zapisaƒá: '+ e.message + '\nU≈ºyjƒô pobierania pliku.');
          await saveFallback(f);
          pushThumb(f);
        }
      }
      fileInput.value = '';
    });
  </script>
</body>
</html>
